---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
---

<Layout title="Crear usuario">
    <Header />

    <div class="max-w-sm mx-auto mt-6">
		<h1 class="text-base text-center mb-3 font-medium text-gray-900">Crear usuario</h1>

        <div class="p-2">
            <form method="POST" class="flex flex-col gap-2" id="createForm">
                <label for="name" class="text-xs text-gray-700">Nombre</label>
                <input
                    id="name"
                    name="name"
                    type="text"
                    placeholder="Nombre completo"
                    class="w-full border-b border-gray-400 px-1 py-1 text-sm focus:outline-none focus:border-blue-700"
                    required
                />
                <input type="text" name="status" id="status" value="1" hidden />
                <div class="mt-2 text-xs text-gray-600 text-center">Por defecto tu estado será <span class="font-medium text-blue-800">Activo</span></div>
                <button id="submitBtn" class="cursor-pointer w-full bg-blue-800 hover:bg-blue-900 text-white py-1 text-sm font-medium" type="submit">Guardar</button>
            </form>

            <div id="successMsg" class="mt-2 hidden text-xs text-green-700">Usuario guardado — redirigiendo…</div>
        </div>
    </div>
    
    <script>
        const form = document.getElementById('createForm') as HTMLFormElement | null;
        const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement | null;
        const successMsg = document.getElementById('successMsg') as HTMLElement | null;

        if (!form || !submitBtn || !successMsg) throw new Error('Form elements not found');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-70', 'cursor-not-allowed');

            const formData = new FormData(form);
            const name = formData.get('name');
            const status = formData.get('status');

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, status }),
                });

                if (response.ok) {
                    form.reset();
                    successMsg.classList.remove('hidden');
                    // Mostrar mensaje breve antes de redirigir
                    setTimeout(() => location.replace('/'), 800);
                } else {
                    const errText = await response.text();
                    alert('Error: ' + errText);
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
            } catch (err) {
                const errorMsg = err instanceof Error ? err.message : 'Error desconocido';
                alert('Error de red: ' + errorMsg);
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        });
    </script>
</Layout>

